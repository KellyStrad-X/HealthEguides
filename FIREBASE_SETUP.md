# Firebase Setup Guide for HealthEGuides

## Overview
This guide will help you set up Firebase Firestore to store purchase records and manage access tokens for your health guides.

---

## Step 1: Create Firebase Project

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Click **"Add project"**
3. Enter project name: `healtheguides-production` (or your preferred name)
4. Disable Google Analytics if not needed (can enable later)
5. Click **"Create project"**

---

## Step 2: Set Up Firestore Database

1. In Firebase Console, click **"Firestore Database"** in the left sidebar
2. Click **"Create database"**
3. Choose **"Start in production mode"** (we'll set custom rules)
4. Select your preferred database location (e.g., `us-central1`)
5. Click **"Enable"**

---

## Step 3: Create Collections & Initial Documents

### Create Collections
You need to create two collections:

#### 1. `purchases` Collection
- Click **"Start collection"**
- Collection ID: `purchases`
- Add a test document (will be deleted later):
  - Document ID: (auto-generated)
  - Fields:
    ```
    email: "test@example.com" (string)
    guideId: "test-guide" (string)
    accessToken: "test-token" (string)
    status: "active" (string)
    purchasedAt: (timestamp - click "timestamp" type)
    ```
- Click **"Save"**
- Delete this test document after creation

#### 2. `guides` Collection (Optional - for dynamic guide management)
- Click **"Start collection"**
- Collection ID: `guides`
- Add your first guide:
  ```
  id: "perimenopause-playbook" (string)
  title: "The Perimenopause Playbook" (string)
  slug: "perimenopause" (string)
  price: 499 (number - in cents)
  isActive: true (boolean)
  createdAt: (timestamp)
  updatedAt: (timestamp)
  ```

**Note:** The `guides` collection is optional since guide data is also stored in `lib/guides.ts`. Use this if you want to manage guides dynamically without code changes.

---

## Step 4: Configure Security Rules

1. Go to **Firestore Database** → **Rules** tab
2. Replace the default rules with:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Guides collection - publicly readable (for catalog display)
    match /guides/{guideId} {
      allow read: if true;
      allow write: if false; // Only backend can write
    }

    // Purchases collection - fully private
    match /purchases/{purchaseId} {
      allow read: if false;  // Only backend API can read
      allow write: if false; // Only backend API can write
    }
  }
}
```

3. Click **"Publish"**

**Security Note:** All access to `purchases` is blocked from the client. Only your Next.js API routes (using Firebase Admin SDK) can read/write purchase data.

---

## Step 5: Set Up Service Account

1. Go to **Project Settings** (gear icon) → **Service Accounts** tab
2. Click **"Generate new private key"**
3. Save the JSON file securely (DO NOT commit to git!)
4. Copy the entire JSON content
5. In your `.env.local` file, add:
   ```
   FIREBASE_SERVICE_ACCOUNT='{"type":"service_account","project_id":"your-project-id",...}'
   ```

**Alternative (Individual Fields):**
```
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYourKeyHere\n-----END PRIVATE KEY-----\n"
```

---

## Step 6: Create Indexes (Optional but Recommended)

Firestore indexes improve query performance. Create these composite indexes:

1. Go to **Firestore Database** → **Indexes** tab
2. Click **"Add index"**

### Index 1: Query purchases by access token
- Collection: `purchases`
- Fields:
  - `accessToken` - Ascending
  - `guideId` - Ascending
  - `status` - Ascending
- Query scope: Collection
- Click **"Create"**

### Index 2: Query purchases by email
- Collection: `purchases`
- Fields:
  - `email` - Ascending
  - `status` - Ascending
- Query scope: Collection
- Click **"Create"**

### Index 3: Query purchases by Stripe session
- Collection: `purchases`
- Fields:
  - `stripeSessionId` - Ascending
  - `guideId` - Ascending
- Query scope: Collection
- Click **"Create"**

**Note:** Firestore will automatically suggest creating indexes when you first run queries that need them. You can create indexes on-demand.

---

## Firebase Schema Reference

### `purchases` Collection

**Document Structure:**
```typescript
{
  id: string,                    // Auto-generated by Firestore
  email: string,                 // Customer email
  guideId: string,               // Guide identifier (from lib/guides.ts)
  guideName: string,             // Guide display name
  accessToken: string,           // Secure access token (64-char hex)
  stripeSessionId: string,       // Stripe checkout session ID
  stripePaymentIntentId: string, // Stripe payment intent ID (for refunds)
  amount: number,                // Amount paid in cents (e.g., 499 = $4.99)
  currency: string,              // Currency code (e.g., "usd")
  isBundle: boolean,             // True if part of a bundle purchase
  purchasedAt: Timestamp,        // When the purchase was made
  lastAccessedAt: Timestamp | null, // Last time guide was accessed
  accessCount: number,           // Number of times guide was accessed
  status: string,                // "active" | "refunded" | "revoked"
  refundedAt?: Timestamp         // When refund was processed (if applicable)
}
```

**Example Document:**
```javascript
{
  email: "customer@example.com",
  guideId: "perimenopause-playbook",
  guideName: "The Perimenopause Playbook",
  accessToken: "a7f3c8e1d9b4f2a8c6e3d7b9f4a2c8e6d3b7f9a4c2e8d6b3f7a9c4e2d8b6f3a7c9",
  stripeSessionId: "cs_test_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0",
  stripePaymentIntentId: "pi_3abc123def456ghi789jkl",
  amount: 499,
  currency: "usd",
  isBundle: false,
  purchasedAt: Timestamp(2025-01-15 14:30:00),
  lastAccessedAt: Timestamp(2025-01-15 14:35:22),
  accessCount: 3,
  status: "active"
}
```

### `guides` Collection (Optional)

**Document Structure:**
```typescript
{
  id: string,           // Guide identifier (matches lib/guides.ts)
  title: string,        // Display title
  slug: string,         // URL slug
  price: number,        // Price in cents
  isActive: boolean,    // Whether guide is available for purchase
  createdAt: Timestamp, // When guide was added
  updatedAt: Timestamp  // Last update timestamp
}
```

---

## Usage Monitoring & Costs

### Free Tier (Spark Plan)
- **Stored data:** 1 GB
- **Document reads:** 50,000/day
- **Document writes:** 20,000/day
- **Document deletes:** 20,000/day
- **Network egress:** 10 GB/month

### Estimated Usage (Per 1,000 Sales/Month)
- **Writes:** ~3,000/month (purchases + updates)
- **Reads:** ~6,000/month (validation + access tracking)
- **Storage:** ~5 MB for 1,000 purchase records

**Conclusion:** Free tier is sufficient for up to **~15,000 purchases/month**. Beyond that, upgrade to Blaze Plan (~$25-50/month for moderate traffic).

### Set Up Budget Alerts
1. Go to **Project Settings** → **Usage and billing**
2. Click **"Set budget alert"**
3. Set threshold (e.g., $25/month)
4. Add your email for notifications

---

## Testing Your Setup

### Test 1: Verify Service Account
Run in your Next.js app:
```bash
npm run dev
```

Check logs for Firebase initialization. Should see no errors.

### Test 2: Manual Purchase Record
1. Go to Firestore console
2. Add a test document to `purchases`:
   ```javascript
   {
     email: "test@example.com",
     guideId: "perimenopause-playbook",
     guideName: "Test Guide",
     accessToken: "test123",
     stripeSessionId: "test_session",
     stripePaymentIntentId: "test_pi",
     amount: 499,
     currency: "usd",
     isBundle: false,
     purchasedAt: (current timestamp),
     lastAccessedAt: null,
     accessCount: 0,
     status: "active"
   }
   ```

### Test 3: Validate Access
Try accessing: `http://localhost:3000/guides/perimenopause?access=test123`

Should work if everything is configured correctly.

---

## Backup Strategy

### Enable Automatic Backups
Firebase doesn't have built-in automatic backups for Firestore. Options:

1. **Export to Cloud Storage (Recommended)**
   - Set up daily exports to Google Cloud Storage
   - [Follow guide](https://firebase.google.com/docs/firestore/manage-data/export-import)

2. **Manual Exports**
   - Use `gcloud firestore export gs://your-bucket-name` command

3. **Third-Party Backup Services**
   - Consider: Firestore Backup, Backup Ninja, etc.

---

## Security Best Practices

✅ **DO:**
- Use strong, random access tokens (crypto.randomBytes)
- Enable Firebase App Check for additional security
- Monitor usage for unusual patterns
- Regularly audit security rules
- Keep service account key secure (never commit!)

❌ **DON'T:**
- Expose Firebase Admin credentials in client code
- Allow client-side writes to purchases collection
- Store sensitive data without encryption
- Share service account keys

---

## Troubleshooting

### "Permission denied" errors
- Check Firestore security rules
- Verify service account has correct permissions
- Ensure Firebase Admin SDK is initialized correctly

### "Collection not found"
- Create collections manually in Firestore Console
- Collections are created automatically on first write

### "Index required" errors
- Firestore will provide a direct link to create the index
- Click the link or create indexes manually (see Step 6)

### Connection issues
- Check internet connectivity
- Verify Firebase project ID is correct
- Ensure service account credentials are valid

---

## Support Resources

- [Firebase Documentation](https://firebase.google.com/docs)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Firebase Admin SDK](https://firebase.google.com/docs/admin/setup)
- [Stack Overflow - Firebase Tag](https://stackoverflow.com/questions/tagged/firebase)

---

## Next Steps

After completing Firebase setup:
1. ✅ Test Stripe integration with test purchases
2. ✅ Verify webhook creates purchase records in Firestore
3. ✅ Test access validation with real tokens
4. ✅ Confirm email delivery works
5. ✅ Test full purchase flow end-to-end

**Ready to go live?** See `DEPLOYMENT_CHECKLIST.md` for production launch steps.
